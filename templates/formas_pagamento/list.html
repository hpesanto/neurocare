{% extends 'base.html' %}

{% block content %}
<h1>Formas de Pagamento</h1>

<div class="toolbar">
    <button id="btnNew" class="btn btn-primary" data-create-url="{% url 'formas_pagamento:create' %}">Novo</button>
</div>

<table class="table" id="formas-table">
    <thead>
        <tr>
            <th>Nome</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for forma in formas %}
        {% include 'formas_pagamento/row.html' with forma=forma %}
        {% empty %}
        <tr>
            <td colspan="2">Nenhuma forma cadastrada.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% block scripts %}
{% load static %}
<script>
    // Delegate clicks for create/edit/view buttons and load the form into the
    // global #modal container via AJAX (same pattern used by Evolução Clínica).
    document.addEventListener('click', function (e) {
        const btn = (e.target.closest && (e.target.closest('button[data-url]') || e.target.closest('button[data-create-url]')));
        if (!btn) return;
        e.preventDefault();
        const url = btn.getAttribute('data-url') || btn.getAttribute('data-create-url');
        if (!url) return;
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
            .then(r => {
                if (!r.ok) throw new Error('Network response was not ok: ' + r.status);
                return r.text();
            })
            .then(html => {
                const modal = document.getElementById('modal');
                if (!modal) throw new Error('Modal container #modal not found');
                modal.innerHTML = html;
                modal.style.display = 'block';
            })
            .catch(err => {
                console.error('formas_pagamento: error loading form', err);
                alert('Erro ao carregar o formulário. Veja o console para detalhes.');
            });
    });
</script>
{% endblock %}
{% endblock %}