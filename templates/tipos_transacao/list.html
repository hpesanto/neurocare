{% extends 'base.html' %}

{% block content %}
<h2>Tipos de Transação Financeira</h2>
<div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;">
    <div style="font-size:0.9rem;color:#666">Total: <strong>{{ items|length }}</strong></div>
</div>

<div class="list-container">
    <table class="table">
        <thead>
            <tr>
                <th>Nome</th>
                <th style="width:160px">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            {% include 'tipos_transacao/row.html' with item=item %}
            {% empty %}
            <tr>
                <td colspan="2">Nenhum tipo registrado.</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="2" style="text-align:right;"><button id="btnNewTipo" class="btn btn-primary"
                        data-url="{% url 'tipos_transacao:create' %}">Novo</button></td>
            </tr>
        </tfoot>
    </table>
</div>


{% endblock %}

{% block scripts %}
{% load static %}
{# rely on global modal_ajax.js to handle data-url and data-delete-url events #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('modal');
        const btnNew = document.getElementById('btnNewTipo');

        function disableViewMode(modalEl) {
            try {
                const form = modalEl.querySelector('form');
                if (!form) return;
                form.querySelectorAll('input,select,textarea').forEach(n => { try { n.setAttribute('disabled', 'disabled'); } catch (e) { } });
                form.querySelectorAll('button, input[type=submit]').forEach(n => {
                    try {
                        const tag = n.tagName.toLowerCase();
                        if (tag === 'button') {
                            if ((n.type || '').toLowerCase() === 'submit') { n.style.display = 'none'; n.setAttribute('disabled', 'disabled'); }
                        } else {
                            n.style.display = 'none'; n.setAttribute('disabled', 'disabled');
                        }
                    } catch (e) { }
                });
            } catch (e) { console.error('tipos_transacao: disableViewMode error', e); }
        }

        async function fetchForm(url, mode) {
            try {
                const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
                if (!res.ok) { console.error('TiposTransacao: fetch failed', res.status); return; }
                const html = await res.text();
                if (!modal) { console.error('TiposTransacao: modal container #modal not found'); return; }
                if (mode) modal.dataset.mode = mode; else delete modal.dataset.mode;
                modal.innerHTML = html; modal.style.display = 'block';
                if (mode === 'view') disableViewMode(modal);
            } catch (err) { console.error('TiposTransacao: fetchForm error', err); alert('Erro ao carregar o formulário. Veja o console para detalhes.'); }
        }

        if (btnNew) btnNew.addEventListener('click', (e) => {
            const url = btnNew.dataset.url || btnNew.getAttribute('data-url');
            if (url) fetchForm(url);
        });

        // attach handlers to rows (will be re-applied when rows are mutated)
        function attachHandlers(root = document) {
            root.querySelectorAll('.btn-edit').forEach((b) => {
                if (b._spAttached) return; b._spAttached = true;
                b.addEventListener('click', (e) => { e.preventDefault(); fetchForm(e.currentTarget.dataset.url); });
            });
            root.querySelectorAll('.btn-view').forEach((b) => {
                if (b._spAttached) return; b._spAttached = true;
                b.addEventListener('click', (e) => { e.preventDefault(); fetchForm(e.currentTarget.dataset.url, 'view'); });
            });
        }

        attachHandlers();
        const tbody = document.querySelector('.list-container table tbody');
        if (tbody) {
            const obs = new MutationObserver(() => attachHandlers(tbody));
            obs.observe(tbody, { childList: true, subtree: true });
        }
    });
</script>
{% endblock %}