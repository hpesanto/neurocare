{% extends 'base.html' %}

{% block content %}
<h1>Produtos</h1>

<div class="toolbar">
    <button id="btnNew" class="btn btn-primary" data-create-url="{% url 'produtos:create' %}">Novo</button>
</div>

<table class="table" id="produtos-table">
    <thead>
        <tr>
            <th>Tipo</th>
            <th>Nome</th>
            <th>Valor Unit.</th>
            <th>Ativo</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for produto in produtos %}
        {% include 'produtos/row.html' with produto=produto %}
        {% empty %}
        <tr>
            <td colspan="5">Nenhum produto cadastrado.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}

{# Use global #modal container from base.html; delegate clicks to load partials via AJAX #}
{% block scripts %}
{% load static %}
<script>
    document.addEventListener('click', function (e) {
        const btn = (e.target.closest && (e.target.closest('button[data-url]') || e.target.closest('button[data-create-url]')));
        if (!btn) return;
        e.preventDefault();
        const url = btn.getAttribute('data-url') || btn.getAttribute('data-create-url');
        if (!url) return;
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
            .then(r => { if (!r.ok) throw new Error('Network response was not ok: ' + r.status); return r.text(); })
            .then(html => {
                const modal = document.getElementById('modal'); if (!modal) throw new Error('Modal container #modal not found');
                modal.innerHTML = html; modal.style.display = 'block';
            })
            .catch(err => { console.error('produtos: error loading form', err); alert('Erro ao carregar o formul√°rio. Veja o console para detalhes.'); });
    });
</script>
{% endblock %}