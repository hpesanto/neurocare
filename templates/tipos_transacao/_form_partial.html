<div id="modal-content">
    <button id="modal-close" aria-label="Fechar" data-modal-close="true"
        style="position:absolute;right:8px;top:8px;background:transparent;border:none;font-size:18px;">Ã—</button>
    <div id="modal-body">
        <h3>{{ title }}</h3>
        <form method="post" action="{{ action }}" id="tipoForm">
            {% csrf_token %}
            {% for field in form %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
                {% if field.errors %}
                <div class="errors">{{ field.errors }}</div>
                {% endif %}
            </div>
            {% endfor %}
            <div style="text-align:right;margin-top:8px;">
                <button type="submit" class="btn">Salvar</button>
                <button type="button" class="btn" id="btnCancel" data-modal-close="true">Fechar</button>
            </div>
        </form>
    </div>

    <script>
        (function () {
            const modal = document.getElementById('modal');

            function closeModal() { if (modal) { modal.style.display = 'none'; modal.innerHTML = ''; } }

            function getCookie(name) { const v = document.cookie.split(';').map(c => c.trim()).find(c => c.startsWith(name + '=')); if (!v) return null; return decodeURIComponent(v.split('=')[1]); }

            const form = document.getElementById('tipoForm');
            if (form) {
                form.addEventListener('submit', function (ev) {
                    ev.preventDefault();
                    const url = form.getAttribute('action') || window.location.href;
                    const data = new FormData(form);
                    fetch(url, { method: 'POST', body: data, credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken') } })
                        .then(r => { const ct = r.headers.get('content-type') || ''; if (ct && ct.includes('application/json')) return r.json(); return r.text(); })
                        .then(resp => {
                            if (typeof resp === 'object') {
                                if (resp.errors) console.warn('Tipo form errors (server):', resp.errors);
                                if (resp.ok) {
                                    if (resp.row_html) {
                                        const tmp = document.createElement('tbody'); tmp.innerHTML = resp.row_html; const newRow = tmp.firstElementChild;
                                        const tbody = document.querySelector('.list-container table tbody'); if (tbody && newRow) tbody.insertAdjacentElement('afterbegin', newRow);
                                    }
                                    closeModal();
                                } else {
                                    if (resp.form_html && modal) modal.innerHTML = resp.form_html;
                                }
                            } else {
                                if (modal) modal.innerHTML = resp;
                            }
                        }).catch(err => { console.error(err); alert('Erro ao salvar.'); });
                });
            }

            setTimeout(() => { const first = document.querySelector('#modal-content form input, #modal-content form select, #modal-content form textarea'); if (first) first.focus(); }, 40);
        })();
    </script>
</div>