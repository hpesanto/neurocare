{% extends 'base.html' %}

{% block content %}
<h1>Paciente x Servico</h1>

<div class="toolbar">
    <button id="btnNew" class="btn btn-primary" data-create-url="{% url 'paciente_servico:create' %}">Novo</button>
</div>

<table class="table" id="paciente-servico-table">
    <thead>
        <tr>
            <th>Paciente</th>
            <th>Tipo Serviço</th>
            <th>Psicólogo</th>
            <th>Início</th>
            <th>Fim</th>
            <th>Ativo</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for servico in servicos %}
        {% include 'paciente_servico/row.html' with servico=servico %}
        {% empty %}
        <tr>
            <td colspan="7">Nenhum registro cadastrado.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}

{# Use global #modal container from base.html; delegate clicks to load partials via AJAX #}
{% block scripts %}
{% load static %}
<script>
    document.addEventListener('click', function (e) {
        const btn = (e.target.closest && (e.target.closest('button[data-url]') || e.target.closest('button[data-create-url]')));
        if (!btn) return;
        e.preventDefault();
        const url = btn.getAttribute('data-url') || btn.getAttribute('data-create-url');
        if (!url) return;
        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
            .then(r => { if (!r.ok) throw new Error('Network response was not ok: ' + r.status); return r.text(); })
            .then(html => {
                const modal = document.getElementById('modal'); if (!modal) throw new Error('Modal container #modal not found');
                modal.innerHTML = html; modal.style.display = 'block';
            })
            .catch(err => { console.error('paciente_servico: error loading form', err); alert('Erro ao carregar o formulário. Veja o console para detalhes.'); });
    });
</script>
{% endblock %}